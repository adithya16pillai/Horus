from enum import Enum
from pydantic import BaseModel, Field, HttpUrl
from typing import List, Dict, Optional, Any
from datetime import datetime


class VulnerabilitySeverity(str, Enum):
    """Vulnerability severity levels"""
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    UNKNOWN = "UNKNOWN"


class AffectedPackage(BaseModel):
    """Information about an affected package"""
    name: str = Field(..., description="Package name")
    ecosystem: str = Field(..., description="Package ecosystem (e.g., PyPI)")
    affected_versions: List[str] = Field([], description="List of affected version specifiers")
    fixed_versions: List[str] = Field([], description="List of fixed version specifiers")
    

class VulnerabilityReference(BaseModel):
    """Reference to external vulnerability information"""
    type: str = Field(..., description="Reference type (e.g., 'ADVISORY', 'WEB')")
    url: HttpUrl = Field(..., description="URL to the reference")


class Vulnerability(BaseModel):
    """Vulnerability information"""
    id: str = Field(..., description="Vulnerability identifier")
    summary: str = Field(..., description="Short summary of the vulnerability")
    details: Optional[str] = Field(None, description="Detailed description")
    severity: VulnerabilitySeverity = Field(VulnerabilitySeverity.UNKNOWN, description="Severity level")
    affected_packages: List[AffectedPackage] = Field(..., description="Affected packages")
    published: Optional[datetime] = Field(None, description="Publication date")
    modified: Optional[datetime] = Field(None, description="Last modification date")
    references: List[VulnerabilityReference] = Field([], description="External references")
    
    class Config:
        schema_extra = {
            "example": {
                "id": "GHSA-p9jm-8pj4-mqx2",
                "summary": "Cross-site Scripting in package-name",
                "details": "A cross-site scripting vulnerability exists in the package that allows attackers to inject malicious code.",
                "severity": "HIGH",
                "affected_packages": [
                    {
                        "name": "package-name",
                        "ecosystem": "PyPI",
                        "affected_versions": [">=1.0.0, <1.2.3"],
                        "fixed_versions": ["1.2.3"]
                    }
                ],
                "published": "2023-01-15T10:00:00Z",
                "modified": "2023-01-20T14:30:00Z",
                "references": [
                    {
                        "type": "ADVISORY",
                        "url": "https://nvd.nist.gov/vuln/detail/CVE-2023-12345"
                    },
                    {
                        "type": "WEB",
                        "url": "https://github.com/owner/repo/security/advisories/GHSA-p9jm-8pj4-mqx2"
                    }
                ]
            }
        }


class VulnerabilityScanResult(BaseModel):
    """Results of a vulnerability scan"""
    repository: str = Field(..., description="Repository name")
    branch: str = Field(..., description="Branch name")
    commit_sha: str = Field(..., description="Commit SHA")
    scan_date: datetime = Field(default_factory=datetime.now, description="Scan date")
    file_type: str = Field(..., description="Type of dependency file")
    dependencies_count: int = Field(..., description="Total number of dependencies")
    vulnerabilities: List[Vulnerability] = Field([], description="Found vulnerabilities")
    
    @property
    def has_vulnerabilities(self) -> bool:
        """Check if any vulnerabilities were found"""
        return len(self.vulnerabilities) > 0
    
    @property
    def vulnerabilities_by_severity(self) -> Dict[VulnerabilitySeverity, int]:
        """Count vulnerabilities by severity"""
        severity_counts = {severity: 0 for severity in VulnerabilitySeverity}
        for vuln in self.vulnerabilities:
            severity_counts[vuln.severity] += 1
        return severity_counts
    
    class Config:
        schema_extra = {
            "example": {
                "repository": "username/example-repo",
                "branch": "main",
                "commit_sha": "abcdef123456",
                "scan_date": "2023-05-20T15:30:00Z",
                "file_type": "requirements.txt",
                "dependencies_count": 15,
                "vulnerabilities": [
                    {
                        "id": "GHSA-p9jm-8pj4-mqx2",
                        "summary": "Cross-site Scripting in package-name",
                        "severity": "HIGH",
                        "affected_packages": [
                            {
                                "name": "package-name",
                                "ecosystem": "PyPI",
                                "affected_versions": [">=1.0.0, <1.2.3"],
                                "fixed_versions": ["1.2.3"]
                            }
                        ],
                        "published": "2023-01-15T10:00:00Z",
                        "references": [
                            {
                                "type": "ADVISORY",
                                "url": "https://nvd.nist.gov/vuln/detail/CVE-2023-12345"
                            }
                        ]
                    }
                ]
            }
        }